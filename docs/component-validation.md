# スウィングトレードシステム コンポーネント検証ガイド

**最終更新**: 2025-12-02

---

## 1. 概要

本ドキュメントでは、スウィングトレードシステムの12の構成要素それぞれの検証方法を定義する。
各要素のパラメータ最適化と、全体としてのパフォーマンス向上を目的とする。

### 関連ドキュメント
- [アーキテクチャ・処理フロー](./architecture-flow.md)

---

## 2. 検証の階層構造

```mermaid
flowchart TD
    subgraph Level1["レベル1: 単一要素検証"]
        L1A[各要素の単体テスト]
        L1B[パラメータ最適化]
    end

    subgraph Level2["レベル2: 統合検証"]
        L2A[ポートフォリオバックテスト]
        L2B[要素間の相互作用確認]
    end

    subgraph Level3["レベル3: 感度分析"]
        L3A[パラメータ変更の影響度]
        L3B[ロバスト性評価]
    end

    Level1 --> Level2 --> Level3
```

| レベル | 目的 | 検証内容 |
|--------|------|---------|
| レベル1 | 単一要素検証 | 各要素が正しく機能するか、最適なパラメータは何か |
| レベル2 | 統合検証 | 全要素を組み合わせた実運用シミュレーション |
| レベル3 | 感度分析 | パラメータ変更が全体パフォーマンスに与える影響 |

---

## 3. 各要素の検証方法

### 3.1 市場レジーム分析

```mermaid
flowchart LR
    subgraph Input[入力]
        I1[過去の市場データ]
        I2[実際のリターン]
    end

    subgraph Process[検証プロセス]
        P1[レジーム判定実行]
        P2[レジーム別リターン集計]
        P3[予測精度計算]
    end

    subgraph Output[評価指標]
        O1[レジーム別平均リターン]
        O2[環境予測の正答率]
        O3[リスク回避効果]
    end

    Input --> Process --> Output
```

| 項目 | 内容 |
|------|------|
| **検証方法** | 過去データでレジーム判定し、各レジームでのリターンを比較 |
| **評価指標** | レジーム別平均リターン、PANIC_SELL時の損失回避率 |
| **パラメータ** | ADX閾値、SMA期間、ATR%閾値、騰落レシオ期間 |
| **期待効果** | 高リスク環境でのエントリー回避による損失軽減 |

**検証クエリ例**:
```
レジーム = PANIC_SELL の期間にエントリーした場合の平均リターン
vs
レジーム = STABLE_UPTREND の期間にエントリーした場合の平均リターン
```

---

### 3.2 銘柄プロファイル

```mermaid
flowchart LR
    subgraph Input[入力]
        I1[銘柄の過去500日データ]
        I2[戦略別実績]
    end

    subgraph Process[検証プロセス]
        P1[プロファイル分類]
        P2[プロファイル別勝率集計]
        P3[推奨戦略の適合率計算]
    end

    subgraph Output[評価指標]
        O1[プロファイル分類の安定性]
        O2[推奨戦略の勝率向上効果]
    end

    Input --> Process --> Output
```

| 項目 | 内容 |
|------|------|
| **検証方法** | プロファイル別に推奨戦略の勝率と全戦略平均を比較 |
| **評価指標** | 推奨戦略の勝率 - 非推奨戦略の勝率、分類安定性 |
| **パラメータ** | ATR%閾値、ADX閾値、反転率閾値、lookback日数 |
| **期待効果** | 銘柄特性に合った戦略選択による勝率向上 |

**検証クエリ例**:
```
プロファイル = HIGH_VOL_TRENDER の銘柄に対して:
  - trend_follow 戦略の勝率
  - mean_reversion 戦略の勝率（推奨外）
→ 推奨戦略の勝率が有意に高いか検証
```

---

### 3.3 イベントカレンダー

```mermaid
flowchart LR
    subgraph Input[入力]
        I1[決算日データ]
        I2[配当/分割日]
        I3[SQ日]
    end

    subgraph Process[検証プロセス]
        P1[イベント前後のリターン分析]
        P2[除外期間設定の効果測定]
        P3[ギャップリスク回避率]
    end

    subgraph Output[評価指標]
        O1[イベント跨ぎ損失回避率]
        O2[除外期間の適切性]
    end

    Input --> Process --> Output
```

| 項目 | 内容 |
|------|------|
| **検証方法** | 決算跨ぎポジションのリターンと非跨ぎを比較 |
| **評価指標** | 決算ギャップによる損失回避率、除外による機会損失 |
| **パラメータ** | 決算前除外日数、決算後再開日数、SQ前除外日数 |
| **期待効果** | 大きなギャップダウンリスクの回避 |

**検証クエリ例**:
```
決算発表日を跨いで保有したポジションの平均リターン
vs
決算前に手仕舞いしたポジションの平均リターン
→ 除外ルールの有効性を検証
```

---

### 3.4 銘柄ユニバース

```mermaid
flowchart LR
    subgraph Input[入力]
        I1[全銘柄]
        I2[フィルター条件]
    end

    subgraph Process[検証プロセス]
        P1[ユニバース構成]
        P2[ユニバース内外の勝率比較]
        P3[流動性閾値の感度分析]
    end

    subgraph Output[評価指標]
        O1[ユニバース内銘柄の平均勝率]
        O2[除外銘柄の損失回避率]
    end

    Input --> Process --> Output
```

| 項目 | 内容 |
|------|------|
| **検証方法** | ユニバース内銘柄 vs 除外銘柄のパフォーマンス比較 |
| **評価指標** | ユニバース内平均勝率、除外銘柄の損失率 |
| **パラメータ** | 流動性閾値（売買代金）、価格範囲、データ品質閾値 |
| **期待効果** | 流動性不足・データ品質問題による損失回避 |

**検証クエリ例**:
```
流動性閾値 = 70M円 で除外された銘柄群の平均リターン
vs
ユニバース採用銘柄の平均リターン
```

---

### 3.5 銘柄スクリーニング

```mermaid
flowchart LR
    subgraph Input[入力]
        I1[ユニバース銘柄]
        I2[テクニカル指標]
    end

    subgraph Process[検証プロセス]
        P1[スクリーニング実行]
        P2[通過/除外別リターン比較]
        P3[各フィルター条件の効果測定]
    end

    subgraph Output[評価指標]
        O1[フィルター通過銘柄の勝率]
        O2[各条件の貢献度]
    end

    Input --> Process --> Output
```

| 項目 | 内容 |
|------|------|
| **検証方法** | フィルター条件の有無でパフォーマンス比較 |
| **評価指標** | フィルター通過銘柄の勝率、各条件の除外効果 |
| **パラメータ** | ADX閾値、RSI範囲、ATR%範囲、出来高比率閾値 |
| **期待効果** | 不適切な銘柄の除外による勝率向上 |

**検証クエリ例**:
```
RSI > 70 で除外された銘柄のその後のリターン
→ 除外が正しかったか（損失回避できたか）検証
```

---

### 3.6 戦略セレクター

```mermaid
flowchart LR
    subgraph Input[入力]
        I1[銘柄 + 市場環境 + 指標]
        I2[マッチング条件]
    end

    subgraph Process[検証プロセス]
        P1[戦略マッチング実行]
        P2[推奨戦略 vs 全戦略の勝率比較]
        P3[信頼度と実績の相関分析]
    end

    subgraph Output[評価指標]
        O1[マッチング精度]
        O2[信頼度と勝率の相関]
    end

    Input --> Process --> Output
```

| 項目 | 内容 |
|------|------|
| **検証方法** | マッチした戦略の勝率と全戦略平均を比較 |
| **評価指標** | 推奨戦略の勝率向上幅、信頼度と実績の相関 |
| **パラメータ** | 各戦略のマッチング条件、信頼度閾値 |
| **期待効果** | 状況に適した戦略選択による勝率向上 |

**検証クエリ例**:
```
戦略セレクターが trend_follow を推奨した場合:
  - trend_follow の勝率
  - 他戦略（mean_reversion等）の勝率
→ 推奨戦略が最適だったか検証
```

---

### 3.7 戦略実行

```mermaid
flowchart LR
    subgraph Input[入力]
        I1[日足データ]
        I2[戦略パラメータ]
    end

    subgraph Process[検証プロセス]
        P1[シグナル生成]
        P2[バックテスト実行]
        P3[パフォーマンス計算]
    end

    subgraph Output[評価指標]
        O1[勝率]
        O2[期待値]
        O3[シャープレシオ]
    end

    Input --> Process --> Output
```

| 項目 | 内容 |
|------|------|
| **検証方法** | 戦略別バックテスト（strategy_backtester.py） |
| **評価指標** | 勝率、平均リターン、期待値、シャープレシオ、最大DD |
| **パラメータ** | エントリー条件、SL/TP倍率、max_holding_days |
| **期待効果** | 各戦略の期待値がプラスであること |

**検証コマンド例**:
```bash
stock-cli swing backtest 7453.T --strategy trend_follow --start-date 2024-01-01
```

---

### 3.8 ポジションサイジング

```mermaid
flowchart LR
    subgraph Input[入力]
        I1[勝率・期待値]
        I2[資金残高]
        I3[リスク許容度]
    end

    subgraph Process[検証プロセス]
        P1[固定比率 vs Kelly基準]
        P2[破産確率シミュレーション]
        P3[資金曲線の安定性分析]
    end

    subgraph Output[評価指標]
        O1[長期成長率]
        O2[破産確率]
        O3[最大ドローダウン]
    end

    Input --> Process --> Output
```

| 項目 | 内容 |
|------|------|
| **検証方法** | 異なるサイジング手法での資金推移シミュレーション |
| **評価指標** | CAGR、破産確率、最大DD、シャープレシオ |
| **パラメータ** | risk_per_trade_pct、Kelly係数、最大ポジション比率 |
| **期待効果** | 長期的な資金成長の最大化とリスク管理 |

**検証クエリ例**:
```
固定2%リスク vs Kelly × 0.5 vs Kelly × 0.25
→ 10年シミュレーションでの最終資金・最大DD比較
```

---

### 3.9 リスク管理

```mermaid
flowchart LR
    subgraph Input[入力]
        I1[シグナル]
        I2[ATR]
        I3[資金]
    end

    subgraph Process[検証プロセス]
        P1[SL/TP設定比較]
        P2[ポジションサイズ比較]
        P3[リスクリワード分析]
    end

    subgraph Output[評価指標]
        O1[リスクリワード比]
        O2[最大ドローダウン]
        O3[破産確率]
    end

    Input --> Process --> Output
```

| 項目 | 内容 |
|------|------|
| **検証方法** | SL/TP設定のバリエーションでバックテスト比較 |
| **評価指標** | リスクリワード比、最大DD、勝率×平均利益 |
| **パラメータ** | SL ATR倍率、TP ATR倍率、risk_per_trade_pct |
| **期待効果** | 最大DDの抑制、長期的な資金成長 |

**検証クエリ例**:
```
SL = 1.5×ATR vs SL = 2.0×ATR vs SL = 2.5×ATR
→ 勝率、平均リターン、最大DDの比較
```

---

### 3.10 執行管理

```mermaid
flowchart LR
    subgraph Input[入力]
        I1[注文情報]
        I2[板情報・流動性]
        I3[約定履歴]
    end

    subgraph Process[検証プロセス]
        P1[スリッページ分析]
        P2[執行タイミング比較]
        P3[注文タイプ効果測定]
    end

    subgraph Output[評価指標]
        O1[実効スリッページ]
        O2[執行コスト率]
        O3[約定率]
    end

    Input --> Process --> Output
```

| 項目 | 内容 |
|------|------|
| **検証方法** | 想定約定価格と実約定価格の差分分析 |
| **評価指標** | 平均スリッページ、執行コスト率、フィルレート |
| **パラメータ** | 注文タイプ、指値オフセット、分割執行比率 |
| **期待効果** | 執行コストの最小化、約定確実性の向上 |

**検証クエリ例**:
```
成行注文 vs 寄付指値 vs 前日終値±0.5%指値
→ 約定率とスリッページの比較
```

---

### 3.11 ポートフォリオ管理

```mermaid
flowchart LR
    subgraph Input[入力]
        I1[複数ポジション]
        I2[ポートフォリオ制約]
    end

    subgraph Process[検証プロセス]
        P1[分散効果測定]
        P2[セクター制限の効果]
        P3[最大銘柄数の感度分析]
    end

    subgraph Output[評価指標]
        O1[ポートフォリオシャープ比]
        O2[分散効果]
        O3[相関リスク]
    end

    Input --> Process --> Output
```

| 項目 | 内容 |
|------|------|
| **検証方法** | ポートフォリオバックテストで分散効果を測定 |
| **評価指標** | ポートフォリオシャープ比、銘柄間相関、最大DD |
| **パラメータ** | max_positions、セクター上限、現金準備率 |
| **期待効果** | 分散によるリスク低減、安定したリターン |

**検証コマンド例**:
```bash
stock-cli swing portfolio-backtest --max-positions 10 --start-date 2024-01-01
stock-cli swing portfolio-backtest --max-positions 20 --start-date 2024-01-01
→ 比較
```

---

### 3.12 パフォーマンス評価

| 項目 | 内容 |
|------|------|
| **検証方法** | N/A（計測側のため検証対象外） |
| **評価指標** | 計算精度の確認（単体テスト） |
| **パラメータ** | なし |
| **備考** | 計算ロジックの正確性は単体テストで担保 |

---

## 4. 統合検証フロー

全要素を組み合わせた検証は、ポートフォリオバックテストで実施する。

```mermaid
flowchart TD
    Start([統合検証開始]) --> Config[パラメータ設定]

    Config --> Step1[1. ユニバース構築]
    Step1 --> Step2[2. 市場レジーム判定]
    Step2 --> Step3[3. スクリーニング + プロファイル照合]
    Step3 --> Step4[4. 戦略マッチング]
    Step4 --> Step5[5. シグナル生成]
    Step5 --> Step6[6. リスク管理適用]
    Step6 --> Step7[7. ポートフォリオ更新]
    Step7 --> Step8[8. パフォーマンス計算]

    Step8 --> Eval{目標達成?<br/>年利40-60%}

    Eval -->|No| Tune[パラメータ調整]
    Tune --> Config

    Eval -->|Yes| End([検証完了])
```

### 統合検証の評価指標

| 指標 | 目標値 | 説明 |
|------|-------|------|
| 年間リターン | 40-60% | 目標収益率 |
| 最大ドローダウン | < 20% | リスク許容範囲 |
| シャープレシオ | > 1.5 | リスク調整後リターン |
| 勝率 | > 50% | 勝ちトレードの割合 |
| プロフィットファクター | > 1.5 | 総利益 / 総損失 |

---

## 5. パラメータ最適化手順

### 5.1 最適化の順序

```mermaid
flowchart TD
    subgraph Phase1[フェーズ1: 基盤要素]
        P1A[1. ユニバース<br/>流動性閾値]
        P1B[2. データ品質<br/>欠損率閾値]
    end

    subgraph Phase2[フェーズ2: 分析要素]
        P2A[3. 市場レジーム<br/>ADX/ATR閾値]
        P2B[4. 銘柄プロファイル<br/>分類閾値]
        P2C[5. イベントカレンダー<br/>除外期間]
    end

    subgraph Phase3[フェーズ3: 選定要素]
        P3A[6. スクリーニング<br/>各指標閾値]
        P3B[7. 戦略セレクター<br/>マッチング条件]
    end

    subgraph Phase4[フェーズ4: 実行要素]
        P4A[8. 戦略パラメータ<br/>エントリー/エグジット]
        P4B[9. ポジションサイジング<br/>Kelly係数]
        P4C[10. リスク管理<br/>SL/TP倍率]
        P4D[11. 執行管理<br/>注文タイプ]
    end

    subgraph Phase5[フェーズ5: 管理要素]
        P5A[12. ポートフォリオ<br/>分散設定]
    end

    Phase1 --> Phase2 --> Phase3 --> Phase4 --> Phase5
```

### 5.2 最適化の注意点

| 注意点 | 説明 |
|--------|------|
| **過学習回避** | アウトオブサンプルデータでの検証必須 |
| **パラメータ依存** | 上流の変更が下流に影響するため、順序を守る |
| **市場環境変化** | 複数期間での検証でロバスト性確認 |
| **計算コスト** | グリッドサーチは範囲を絞って実施 |

### 5.3 推奨アプローチ

1. **粗い探索**: パラメータを大きく変化させて傾向把握
2. **細かい探索**: 有望な範囲で詳細探索
3. **アウトオブサンプル検証**: 別期間データで確認
4. **感度分析**: 最適値周辺でのロバスト性確認

---

## 6. 検証結果の記録

検証結果は以下の形式で記録することを推奨:

```yaml
# config/validation_results/YYYY-MM-DD_component_name.yml
validation:
  component: market_regime
  date: 2025-12-01
  parameters:
    adx_trending_threshold: 25
    atr_elevated_threshold: 3.0
  results:
    sample_period: 2024-01-01 to 2024-12-31
    metrics:
      regime_accuracy: 0.72
      panic_avoidance_rate: 0.85
      avg_return_by_regime:
        STABLE_UPTREND: 0.032
        PANIC_SELL: -0.045
  notes: |
    ADX閾値を25から20に下げると、レンジ相場の検出精度が向上するが
    トレンド相場での誤判定が増加
```

---

**最終更新**: 2025-12-02
